<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Space Piano</title>
        <script src="js/jquery-2.1.0.min.js"></script>
        <script src="js/leap.js"></script>
        <script src="js/three.js"></script>

		<!--  Stolen wholesale from the MIDI.js demo-Basic.html file -->
	    	<script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
	    	<script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
	    	<script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
	    	<script src="./js/MIDI/Player.js" type="text/javascript"></script>
	    	<script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
	    	<!-- extras -->
	    	<script src="./inc/Base64.js" type="text/javascript"></script>
	    	<script src="./inc/base64binary.js" type="text/javascript"></script>		
		<!--  END: demo-Basic.html rip off code :) thanks to the original author -->
		<script src="js/PianoLayer.js"></script>
        <script src="js/SoundLayer.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">
		
    </head>
    <body>

	<div id="p-wrapper">
	<ul id="piano">
		<li><div class="anchor"></div></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
		<li><div class="anchor"></div><span></span></li>
	</ul>
</div>
<div class="fingerpoint"></div>

		
        <script>
          var WHITEKEY_NUMBER = 14;
          var OVERALL_BORDER = 0.02;
          var KEY_WIDTH = (1 - 2 * OVERALL_BORDER) / WHITEKEY_NUMBER;
          var KEYTOUCH_THRESHOLD = 0.05;

          Leap.loop(function (frame) {

              var hands = frame.hands;
              var pointables = frame.pointables;

              var pointableOutput = document.getElementById("result");
              var pointableString = "";

              var keyList = getAllTouchedKeys(frame);

              for (var i = 0; i < keyList.length; i++) {
                  pointableString += keyList[i].printKey();
              }
              //pointableOutput.innerHTML = pointableString;
          });

          function getAllTouchedKeys(frame) {
              var resultList = [];
              var pointables = frame.pointables;

              for (var i = 0, pointable; pointable = pointables[i++]; ) {
                  var interactionBox = frame.interactionBox;
                  var normalizedPosition = interactionBox.normalizePoint(pointable.tipPosition, true);
                  if (normalizedPosition[1] < 0.5 + KEYTOUCH_THRESHOLD &&
                      normalizedPosition[1] > 0.5 - KEYTOUCH_THRESHOLD) {
                      var key = findKey(normalizedPosition);
                      
                      if (key) {
                          key.setVelocity(interactionBox.normalizePoint(pointable.tipVelocity, true)[1]);
                          resultList.push(key);
                      }
                  }
                  console.log(normalizedPosition[0]);
              }
              return resultList;
          }

          function findKey(pos) {

              var xIndex = Math.floor((pos[0] - OVERALL_BORDER) / KEY_WIDTH);
              if (pos[2] > 0.5 && xIndex >= 0 && xIndex < WHITEKEY_NUMBER) {
                  return new KeyTouch(true, xIndex, 0);
              }

              if (pos[2] < 0.5 && xIndex >= 0 && xIndex < WHITEKEY_NUMBER
                    && xIndex % 7 != 2 && xIndex % 7 != 6) {
                  return new KeyTouch(false, xIndex, 0);
              }
          }

          function KeyTouch(isWhite, keyIndex, velocity) {
              var _keyIndex = keyIndex;
              var _isWhite = isWhite;
              var _velocity = velocity;

              return {
                  printKey: function () {
                      return "note: " + _keyIndex + "<br />" + "isWhite: " + _isWhite +
                  "<br />" + _velocity + "<br />";
                  },
                  setVelocity: function (velocity) {
                      _velocity = velocity;
                  }
              }
          }


        </script>
    </body>
</html>
